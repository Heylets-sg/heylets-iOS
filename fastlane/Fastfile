default_platform(:ios)

desc "build app and upload to testflight"
lane :upload_testflight do |version|
  version = version[:version]

  match(
    type: "appstore",
    app_identifier: ['com.heeom.Heylets-iOS.release']
    #readonly: true
  )
  increment_build_number(
    build_number: latest_testflight_build_number + 1,
    xcodeproj: "./Projects/APP/Heylets-iOS.xcodeproj"
  )

  # ë¹Œë“œí•  ì•±
  build_app(scheme: "Heylets-iOS-PROD")

  # TestFlightì— ì—…ë¡œë“œ
  upload_to_testflight(skip_waiting_for_build_processing: false)

  # Slackì— ë©”ì‹œì§€ ë³´ë‚´ê¸°
  slack(
    message: "Testflight ë°°í¬ ì„±ê³µ ğŸ€",
    slack_url: "https://hooks.slack.com/services/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",
    payload: {
        "Build Date" => Time.new.to_s,
    },
    success: true
  )
end

platform :ios do
  error do |lane, exception, options|
    slack(
      message: "ì—ëŸ¬ ë°œìƒ : #{exception}",
      success: false,
      slack_url: "https://hooks.slack.com/services/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"
    )
  end
end