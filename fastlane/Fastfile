default_platform(:ios)

desc "Build app and upload to TestFlight"
lane :upload_testflight do
  app_store_connect_api_key(
    key_id: "{KEY_ID}",
    issuer_id: "{ISSUER_ID}",
    key_filepath: "fastlane/AuthKey_8F7ZA35DHY.p8"
  )

  match(type: "appstore")

  # ìµœì‹  TestFlight ë¹Œë“œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
  latest_build_number = latest_testflight_build_number(version: "{APP_VERSION}")

  # ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
  increment_build_number(
    build_number: latest_build_number + 1,
    xcodeproj: "{PATH}/{PROJECT_NAME}.xcodeproj"
  )

  # ì•± ë¹Œë“œ
  build_app(
    workspace: "{WORKSPACE_NAME}.xcworkspace",
    scheme: "{SCHEME_NAME}",
    clean: true,
    export_method: "app-store",
    include_bitcode: false
  )

  # TestFlight ì—…ë¡œë“œ
  upload_to_testflight(
    username: "{USER_EMAIL}",
    app_identifier: "{APP_BUNDLE_ID}"
  )

  # Slackì— ë©”ì‹œì§€ ë³´ë‚´ê¸°
  slack(
    message: "TestFlight ë°°í¬ ì„±ê³µ ğŸ€",
    slack_url: "https://hooks.slack.com/services/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",
    payload: {
      "Build Date" => Time.now.to_s
    },
    success: true
  )
end

# ê³µí†µ ì—ëŸ¬ í•¸ë“¤ë§
error do |lane, exception, _options|
  slack(
    message: "ğŸš¨ Fastlane ì—ëŸ¬ ë°œìƒ: #{exception}",
    success: false,
    slack_url: "https://hooks.slack.com/services/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"
  )
end
